<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奶茶店后台管理系统- 优惠券管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/admin-modern.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            color: white;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
        }
        .sidebar a:hover {
            background-color: #495057;
        }
        .content {
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
        }
        .table th {
            white-space: nowrap;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .coupon-type-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .full-type {
            background-color: #17a2b8;
            color: white;
        }
        .no-threshold-type {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏-->
            <div class="col-md-2 sidebar">
                <div class="p-3 bg-dark text-center">
                    <h5>奶茶店管理系统</h5>
                </div>
                <ul class="nav flex-column p-3">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-house"></i> 首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/products">
                            <i class="bi bi-box"></i> 商品管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/orders">
                            <i class="bi bi-cart"></i> 订单管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">
                            <i class="bi bi-people-fill"></i> 用户管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/members">
                            <i class="bi bi-people"></i> 会员管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/member-levels">
                            <i class="bi bi-crown"></i> 会员等级
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/coupons">
                            <i class="bi bi-ticket"></i> 优惠券管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/stores">
                            <i class="bi bi-building"></i> 店铺管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/recharge">
                            <i class="bi bi-wallet2"></i> 储值管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/group-buy">
                            <i class="bi bi-people-fill"></i> 团购管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/ui">
                            <i class="bi bi-layout"></i> UI管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/delivery-platforms">
                            <i class="bi bi-truck"></i> 外卖平台
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/stats">
                            <i class="bi bi-bar-chart"></i> 数据统计
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="/admin/logout">
                            <i class="bi bi-box-arrow-right"></i> 退出登录
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- 主内容区 -->
            <div class="col-md-10 content">
                <!-- 顶部导航栏-->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
                    <div class="container-fluid">
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarNav">
                            <ul class="navbar-nav ms-auto">
                                <li class="nav-item">
                                    <span class="nav-link">欢迎 <strong>admin</strong></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
                
                <!-- 优惠券管理页面-->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">优惠券管理</h5>
                        <button class="btn btn-primary" onclick="openAddModal()">
                            <i class="bi bi-plus"></i> 添加优惠券
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- 搜索和筛�?-->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="searchInput" placeholder="搜索优惠券">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="typeFilter">
                                    <option value="">所有类型</option>
                                    <option value="full">满减券</option>
                                    <option value="no-threshold">无门槛券</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="statusFilter">
                                    <option value="">所有状态</option>
                                    <option value="1">已激活</option>
                                    <option value="0">已禁用</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary" onclick="searchCoupons()">
                                    <i class="bi bi-search"></i> 搜索
                                </button>
                                <button class="btn btn-secondary ms-2" onclick="resetFilters()">
                                    <i class="bi bi-arrow-counterclockwise"></i> 重置
                                </button>
                            </div>
                        </div>
                        
                        <!-- 优惠券列表-->
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>优惠券信息</th>
                                        <th>类型</th>
                                        <th>金额</th>
                                        <th>使用条件</th>
                                        <th>有效期</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="couponsTableBody">
                                    <!-- 优惠券数据将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑优惠券模态框 -->
    <div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="couponModalLabel">添加优惠券</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="couponForm">
                        <input type="hidden" id="couponId">
                        
                        <div class="mb-3">
                            <label for="couponTitle" class="form-label">优惠券名称</label>
                            <input type="text" class="form-control" id="couponTitle" required placeholder="请输入优惠券名称">
                        </div>

                        <div class="mb-3">
                            <label for="couponDesc" class="form-label">优惠券描述</label>
                            <textarea class="form-control" id="couponDesc" rows="2" placeholder="请输入优惠券描述"></textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="couponAmount" class="form-label">优惠金额</label>
                                <input type="number" class="form-control" id="couponAmount" step="0.01" min="0" required placeholder="请输入优惠金额">
                            </div>
                            <div class="col-md-6">
                                <label for="couponType" class="form-label">优惠券类型</label>
                                <select class="form-select" id="couponType" required>
                                    <option value="full">满减券</option>
                                    <option value="no-threshold">无门槛券</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="couponMinAmount" class="form-label">最低使用金额</label>
                            <input type="number" class="form-control" id="couponMinAmount" step="0.01" min="0" placeholder="请输入最低使用金额">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="couponStartTime" class="form-label">开始时间</label>
                                <input type="datetime-local" class="form-control" id="couponStartTime" required>
                            </div>
                            <div class="col-md-6">
                                <label for="couponEndTime" class="form-label">结束时间</label>
                                <input type="datetime-local" class="form-control" id="couponEndTime" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isSystemCoupon">
                                <label class="form-check-label" for="isSystemCoupon">系统优惠券</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isActiveCoupon" checked>
                                <label class="form-check-label" for="isActiveCoupon">激活状态</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveCoupon()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let coupons = [];

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            loadCoupons();
        });

        // 加载优惠券列表
        async function loadCoupons() {
            try {
                const response = await fetch('/api/coupons');
                const data = await response.json();
                if (data.coupons) {
                    coupons = data.coupons;
                    renderCoupons();
                }
            } catch (error) {
                console.error('加载优惠券失败', error);
                alert('加载优惠券失败，请稍后重试');
            }
        }
        
        // 渲染优惠券列表
        function renderCoupons() {
            const tbody = document.getElementById('couponsTableBody');
            tbody.innerHTML = '';

            // 应用搜索和筛选
            let filteredCoupons = [...coupons];

            const searchText = document.getElementById('searchInput').value.toLowerCase();
            if (searchText) {
                filteredCoupons = filteredCoupons.filter(coupon =>
                    coupon.title.toLowerCase().includes(searchText) ||
                    (coupon.desc && coupon.desc.toLowerCase().includes(searchText))
                );
            }

            const typeFilter = document.getElementById('typeFilter').value;
            if (typeFilter) {
                filteredCoupons = filteredCoupons.filter(coupon => coupon.type === typeFilter);
            }

            const statusFilter = document.getElementById('statusFilter').value;
            if (statusFilter !== '') {
                filteredCoupons = filteredCoupons.filter(coupon => coupon.is_active === parseInt(statusFilter));
            }

            if (filteredCoupons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">暂无优惠券数据</td></tr>';
                return;
            }

            filteredCoupons.forEach(coupon => {
                const row = document.createElement('tr');

                // 格式化有效期
                const startDate = new Date(coupon.start_time).toLocaleString();
                const endDate = new Date(coupon.end_time).toLocaleString();

                // 格式化使用条件
                const useCondition = coupon.type === 'full' ? `满${coupon.min_amount}使用` : '无门槛使用';

                // 格式化优惠券类型
                const typeBadge = coupon.type === 'full'
                    ? '<span class="coupon-type-badge full-type">满减券</span>'
                    : '<span class="coupon-type-badge no-threshold-type">无门槛券</span>';

                // 格式化状态
                const statusBadge = coupon.is_active
                    ? '<span class="badge bg-success">已激活</span>'
                    : '<span class="badge bg-danger">已禁用</span>';

                row.innerHTML = `
                    <td>${coupon.id}</td>
                    <td>
                        <div>
                            <strong>${coupon.title}</strong>
                            ${coupon.desc ? `<div class="text-muted small">${coupon.desc}</div>` : ''}
                        </div>
                    </td>
                    <td>${typeBadge}</td>
                    <td>¥${coupon.amount.toFixed(2)}</td>
                    <td>${useCondition}</td>
                    <td>${startDate}<br><br>${endDate}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${JSON.stringify(coupon).replace(/"/g, '&quot;')})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteCoupon(${coupon.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 打开添加优惠券模态框
        function openAddModal() {
            document.getElementById('couponModalLabel').textContent = '添加优惠券';
            document.getElementById('couponForm').reset();
            document.getElementById('couponId').value = '';

            // 设置默认开始时间和结束时间
            const now = new Date();
            const endDate = new Date(now);
            endDate.setMonth(endDate.getMonth() + 1);

            document.getElementById('couponStartTime').value = now.toISOString().slice(0, 16);
            document.getElementById('couponEndTime').value = endDate.toISOString().slice(0, 16);

            new bootstrap.Modal(document.getElementById('couponModal')).show();
        }

        // 打开编辑优惠券模态框
        function openEditModal(coupon) {
            document.getElementById('couponModalLabel').textContent = '编辑优惠券';
            document.getElementById('couponId').value = coupon.id;
            document.getElementById('couponTitle').value = coupon.title;
            document.getElementById('couponDesc').value = coupon.desc || '';
            document.getElementById('couponAmount').value = coupon.amount;
            document.getElementById('couponType').value = coupon.type;
            document.getElementById('couponMinAmount').value = coupon.min_amount;
            document.getElementById('couponStartTime').value = new Date(coupon.start_time).toISOString().slice(0, 16);
            document.getElementById('couponEndTime').value = new Date(coupon.end_time).toISOString().slice(0, 16);
            document.getElementById('isSystemCoupon').checked = coupon.is_system === 1;
            document.getElementById('isActiveCoupon').checked = coupon.is_active === 1;

            new bootstrap.Modal(document.getElementById('couponModal')).show();
        }

        // 保存优惠券
        async function saveCoupon() {
            const form = document.getElementById('couponForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const couponId = document.getElementById('couponId').value;
            const couponData = {
                title: document.getElementById('couponTitle').value,
                desc: document.getElementById('couponDesc').value,
                amount: parseFloat(document.getElementById('couponAmount').value),
                type: document.getElementById('couponType').value,
                min_amount: parseFloat(document.getElementById('couponMinAmount').value) || 0,
                start_time: new Date(document.getElementById('couponStartTime').value).toISOString(),
                end_time: new Date(document.getElementById('couponEndTime').value).toISOString(),
                is_system: document.getElementById('isSystemCoupon').checked ? 1 : 0,
                is_active: document.getElementById('isActiveCoupon').checked ? 1 : 0
            };
            
            try {
                let response;
                if (couponId) {
                    // 更新优惠券
                    response = await fetch(`/api/coupons/${couponId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(couponData)
                    });
                } else {
                    // 添加优惠券
                    response = await fetch('/api/coupons', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(couponData)
                    });
                }
                
                if (response.ok) {
                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('couponModal')).hide();
                    // 重新加载优惠券列表
                    loadCoupons();
                    alert('优惠券保存成功！');
                } else {
                    const errorData = await response.json();
                    alert('保存失败：' + (errorData.error || '未知错误'));
                }
            } catch (error) {
                console.error('保存优惠券失败', error);
                alert('保存优惠券失败，请稍后重试);
            }
        }

        // 删除优惠券
        async function deleteCoupon(couponId) {
            if (!confirm('确定要删除该优惠券吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/coupons/${couponId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // 重新加载优惠券列表
                    loadCoupons();
                    alert('优惠券删除成功！');
                } else {
                    const errorData = await response.json();
                    alert('删除失败：' + (errorData.error || '未知错误'));
                }
            } catch (error) {
                console.error('删除优惠券失败', error);
                alert('删除优惠券失败，请稍后重试);
            }
        }

        // 搜索优惠券
        function searchCoupons() {
            renderCoupons();
        }

        // 重置筛选
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            renderCoupons();
        }

        // 回车键搜索
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCoupons();
            }
        });
    </script>
</body>
</html>
