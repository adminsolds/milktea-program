<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奶茶店后台管理系统 - 商品推荐</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/admin-modern.css">
</head>
<body>
    <div class="wrapper">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h5>奶茶店管理系统</h5>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/admin/dashboard">
                        <i class="bi bi-house"></i> 首页
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/pos">
                        <i class="bi bi-shop"></i> 现场点单
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/products">
                        <i class="bi bi-box"></i> 商品管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/admin/recommendations">
                        <i class="bi bi-star"></i> 商品推荐
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/orders">
                        <i class="bi bi-cart"></i> 订单管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/users">
                        <i class="bi bi-people-fill"></i> 用户管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/members">
                        <i class="bi bi-people"></i> 会员管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/coupons">
                        <i class="bi bi-ticket"></i> 优惠券管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/stores">
                        <i class="bi bi-building"></i> 店铺管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/recharge">
                        <i class="bi bi-wallet2"></i> 储值管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/groupBuy">
                        <i class="bi bi-people-fill"></i> 团购管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/ui">
                        <i class="bi bi-palette-fill"></i> UI管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/delivery-platforms">
                        <i class="bi bi-truck"></i> 外卖平台
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/stats">
                        <i class="bi bi-bar-chart"></i> 数据统计
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/logout">
                        <i class="bi bi-box-arrow-right"></i> 退出登录
                    </a>
                </li>
            </ul>
        </nav>

        <div class="main-content">
            <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
                <div class="container-fluid d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-star"></i> 商品推荐</h4>
                    <span class="text-muted">欢迎，<strong>admin</strong></span>
                </div>
            </nav>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">推荐列表</h5>
                    <button class="btn btn-primary" onclick="openAddModal()">
                        <i class="bi bi-plus"></i> 添加推荐
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select class="form-select" id="typeFilter" onchange="loadRecommendations()">
                                <option value="">所有类型</option>
                                <option value="new">新品推荐</option>
                                <option value="hot">热门推荐</option>
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="statusFilter" onchange="loadRecommendations()">
                                <option value="">所有状态</option>
                                <option value="1">已激活</option>
                                <option value="0">已禁用</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>图片</th>
                                    <th>类型</th>
                                    <th>标题</th>
                                    <th>链接类型</th>
                                    <th>关联商品</th>
                                    <th>排序</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="recommendationList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑推荐模态框 -->
    <div class="modal fade" id="recommendationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">添加推荐</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recommendationForm">
                        <input type="hidden" id="recommendationId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">推荐类型</label>
                                <select class="form-select" id="recommendationType">
                                    <option value="new">新品推荐</option>
                                    <option value="hot">热门推荐</option>
                                    <option value="custom">自定义</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">标题（可选）</label>
                                <input type="text" class="form-control" id="recommendationTitle" placeholder="推荐标题">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">推荐图片</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="recommendationImage" placeholder="图片URL或点击上传">
                                <button type="button" class="btn btn-primary" onclick="triggerImageUpload()">
                                    <i class="bi bi-upload"></i> 上传
                                </button>
                            </div>
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                            <small class="text-muted">推荐图片尺寸：300×400像素</small>
                            <div class="mt-2" id="imagePreview"></div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">链接类型</label>
                                <select class="form-select" id="linkType" onchange="handleLinkTypeChange()">
                                    <option value="product">商品详情</option>
                                    <option value="custom">自定义链接</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="productSelectContainer">
                                <label class="form-label">关联商品</label>
                                <select class="form-select" id="productSelect">
                                    <option value="">请选择商品</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="customLinkContainer" style="display: none;">
                                <label class="form-label">自定义链接</label>
                                <input type="text" class="form-control" id="customLink" placeholder="输入链接URL">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">排序</label>
                                <input type="number" class="form-control" id="sortOrder" value="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">状态</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="isActive" id="activeYes" value="1" checked>
                                    <label class="form-check-label" for="activeYes">激活</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="isActive" id="activeNo" value="0">
                                    <label class="form-check-label" for="activeNo">禁用</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveRecommendation()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let recommendationModal;

        document.addEventListener('DOMContentLoaded', function() {
            recommendationModal = new bootstrap.Modal(document.getElementById('recommendationModal'));
            loadRecommendations();
            loadProducts();
            setupImageUpload();
        });

        function loadRecommendations() {
            const type = document.getElementById('typeFilter').value;
            const status = document.getElementById('statusFilter').value;

            let url = '/api/recommendations?';
            if (type) url += `type=${type}&`;
            if (status) url += `is_active=${status}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    renderRecommendations(data);
                })
                .catch(err => {
                    console.error('加载推荐列表失败:', err);
                    showToast('加载推荐列表失败', 'error');
                });
        }

        function renderRecommendations(recommendations) {
            const tbody = document.getElementById('recommendationList');

            if (recommendations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">暂无推荐数据</td></tr>';
                return;
            }

            const typeNames = {
                'new': '新品推荐',
                'hot': '热门推荐',
                'custom': '自定义'
            };

            const linkTypeNames = {
                'product': '商品详情',
                'custom': '自定义链接'
            };

            tbody.innerHTML = recommendations.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>
                        <img src="${item.image}" style="width: 60px; height: 80px; object-fit: cover; border-radius: 4px;">
                    </td>
                    <td><span class="badge bg-info">${typeNames[item.type] || item.type}</span></td>
                    <td>${item.title || '-'}</td>
                    <td>${linkTypeNames[item.link_type] || item.link_type}</td>
                    <td>${item.product ? item.product.name : '-'}</td>
                    <td>${item.sort_order}</td>
                    <td>
                        <span class="badge ${item.is_active ? 'bg-success' : 'bg-danger'}">
                            ${item.is_active ? '激活' : '禁用'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editRecommendation(${item.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-${item.is_active ? 'warning' : 'success'} ms-1" onclick="toggleStatus(${item.id})">
                            <i class="bi bi-${item.is_active ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteRecommendation(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function loadProducts() {
            fetch('/api/products?limit=1000')
                .then(res => res.json())
                .then(data => {
                    const products = data.products || data;
                    const select = document.getElementById('productSelect');
                    select.innerHTML = '<option value="">请选择商品</option>' +
                        products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                })
                .catch(err => console.error('加载商品列表失败:', err));
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = '添加推荐';
            document.getElementById('recommendationForm').reset();
            document.getElementById('recommendationId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('linkType').value = 'product';
            handleLinkTypeChange();
            recommendationModal.show();
        }

        function editRecommendation(id) {
            fetch(`/api/recommendations/${id}`)
                .then(res => res.json())
                .then(item => {
                    document.getElementById('modalTitle').textContent = '编辑推荐';
                    document.getElementById('recommendationId').value = item.id;
                    document.getElementById('recommendationType').value = item.type;
                    document.getElementById('recommendationTitle').value = item.title || '';
                    document.getElementById('recommendationImage').value = item.image;
                    document.getElementById('linkType').value = item.link_type;
                    document.getElementById('sortOrder').value = item.sort_order;

                    if (item.link_type === 'product' && item.product_id) {
                        document.getElementById('productSelect').value = item.product_id;
                    } else if (item.link_type === 'custom') {
                        document.getElementById('customLink').value = item.link_url || '';
                    }
                    handleLinkTypeChange();

                    document.getElementById(item.is_active ? 'activeYes' : 'activeNo').checked = true;

                    showImagePreview(item.image);
                    recommendationModal.show();
                })
                .catch(err => {
                    console.error('获取推荐详情失败:', err);
                    showToast('获取推荐详情失败', 'error');
                });
        }

        function handleLinkTypeChange() {
            const linkType = document.getElementById('linkType').value;
            const productContainer = document.getElementById('productSelectContainer');
            const customContainer = document.getElementById('customLinkContainer');

            if (linkType === 'product') {
                productContainer.style.display = 'block';
                customContainer.style.display = 'none';
            } else {
                productContainer.style.display = 'none';
                customContainer.style.display = 'block';
            }
        }

        function saveRecommendation() {
            const id = document.getElementById('recommendationId').value;
            const linkType = document.getElementById('linkType').value;

            const data = {
                type: document.getElementById('recommendationType').value,
                title: document.getElementById('recommendationTitle').value || null,
                image: document.getElementById('recommendationImage').value,
                link_type: linkType,
                product_id: linkType === 'product' ? document.getElementById('productSelect').value : null,
                link_url: linkType === 'custom' ? document.getElementById('customLink').value : null,
                sort_order: parseInt(document.getElementById('sortOrder').value) || 0,
                is_active: parseInt(document.querySelector('input[name="isActive"]:checked').value)
            };

            if (!data.image) {
                showToast('请上传推荐图片', 'error');
                return;
            }

            if (linkType === 'product' && !data.product_id) {
                showToast('请选择关联商品', 'error');
                return;
            }

            const url = id ? `/api/recommendations/${id}` : '/api/recommendations';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(res => {
                    if (res.ok) {
                        showToast(id ? '更新成功' : '添加成功', 'success');
                        recommendationModal.hide();
                        loadRecommendations();
                    } else {
                        return res.json().then(err => { throw new Error(err.error); });
                    }
                })
                .catch(err => {
                    showToast('保存失败: ' + err.message, 'error');
                });
        }

        function toggleStatus(id) {
            fetch(`/api/recommendations/${id}/toggle`, { method: 'PUT' })
                .then(res => res.json())
                .then(() => {
                    showToast('状态更新成功', 'success');
                    loadRecommendations();
                })
                .catch(err => {
                    showToast('状态更新失败', 'error');
                });
        }

        function deleteRecommendation(id) {
            if (!confirm('确定要删除这条推荐吗？')) return;

            fetch(`/api/recommendations/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        showToast('删除成功', 'success');
                        loadRecommendations();
                    } else {
                        showToast('删除失败', 'error');
                    }
                })
                .catch(err => {
                    showToast('删除失败', 'error');
                });
        }

        function triggerImageUpload() {
            document.getElementById('imageUpload').click();
        }

        function setupImageUpload() {
            document.getElementById('imageUpload').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('image', file);

                try {
                    document.getElementById('recommendationImage').value = '上传中...';
                    const response = await fetch('/api/upload/image', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result.success) {
                        document.getElementById('recommendationImage').value = result.url;
                        showImagePreview(result.url);
                        showToast('图片上传成功', 'success');
                    } else {
                        showToast('上传失败: ' + (result.message || '未知错误'), 'error');
                        document.getElementById('recommendationImage').value = '';
                    }
                } catch (err) {
                    showToast('图片上传失败', 'error');
                    document.getElementById('recommendationImage').value = '';
                }
            });
        }

        function showImagePreview(url) {
            const preview = document.getElementById('imagePreview');
            if (url) {
                preview.innerHTML = `<img src="${url}" style="width: 150px; height: 200px; object-fit: cover; border-radius: 4px;">`;
            } else {
                preview.innerHTML = '';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 200px;';
            toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'}"></i> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
