<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奶茶店后台管理系统 - 外卖平台管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/admin-modern.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            color: white;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
        }
        .sidebar a:hover {
            background-color: #495057;
        }
        .content {
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
        }
        .platform-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border-radius: 4px;
        }
        .platform-icon-placeholder {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-2 sidebar">
                <div class="p-3 bg-dark text-center">
                    <h5>奶茶店管理系统</h5>
                </div>
                <ul class="nav flex-column p-3">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-house"></i> 首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/pos">
                            <i class="bi bi-shop"></i> 现场点单
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/products">
                            <i class="bi bi-box"></i> 商品管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/recommendations">
                            <i class="bi bi-star"></i> 商品推荐
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/orders">
                            <i class="bi bi-phone"></i> 小程序订单
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/all-orders">
                            <i class="bi bi-cart"></i> 订单管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">
                            <i class="bi bi-people-fill"></i> 用户管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/members">
                            <i class="bi bi-people"></i> 会员管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/coupons">
                            <i class="bi bi-ticket"></i> 优惠券管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/recharge">
                            <i class="bi bi-wallet2"></i> 储值管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/stores">
                            <i class="bi bi-building"></i> 店铺管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/group-buy">
                            <i class="bi bi-people-fill"></i> 团购管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/ui">
                            <i class="bi bi-palette-fill"></i> UI管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/delivery-platforms">
                            <i class="bi bi-truck"></i> 外卖平台
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/stores">
                            <i class="bi bi-building"></i> 店铺管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/stats">
                            <i class="bi bi-bar-chart"></i> 数据统计
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="/admin/logout">
                            <i class="bi bi-box-arrow-right"></i> 退出登录
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- 主内容区 -->
            <div class="col-md-10 content">
                <!-- 顶部导航栏 -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
                    <div class="container-fluid d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="bi bi-truck"></i> 外卖平台</h4>
                        <span class="text-muted">欢迎，<strong>admin</strong></span>
                    </div>
                </nav>
                
                <!-- 外卖平台管理页面 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">外卖平台管理</h5>
                        <button class="btn btn-primary" onclick="openAddModal()">
                            <i class="bi bi-plus"></i> 添加平台
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>排序</th>
                                        <th>图标</th>
                                        <th>平台名称</th>
                                        <th>平台代码</th>
                                        <th>网页链接</th>
                                        <th>APP链接</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="platformsTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑平台模态框 -->
    <div class="modal fade" id="platformModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">添加外卖平台</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="platformForm">
                        <input type="hidden" id="platformId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">平台名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="platformName" required placeholder="如：美团外卖" onblur="generatePlatformCode()">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">平台代码 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="platformCode" required placeholder="如：meituan">
                                <div class="form-text">唯一标识，英文字母和下划线</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">平台类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="platformType" onchange="onPlatformTypeChange()">
                                <option value="food_delivery">外卖平台（美团、饿了么等）</option>
                                <option value="delivery_service">配送平台（顺丰、达达等）</option>
                            </select>
                            <div class="form-text" id="platformTypeHelp">接收外卖平台推送的订单</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">平台图标</label>
                                <input type="text" class="form-control" id="platformIcon" placeholder="图标URL">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">排序</label>
                                <input type="number" class="form-control" id="platformSort" value="0">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">网页端链接</label>
                                <input type="url" class="form-control" id="platformWebUrl" placeholder="https://...">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">APP跳转链接</label>
                                <input type="text" class="form-control" id="platformAppUrl" placeholder="如：meituanwaimai://...">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">外卖平台API地址 <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" id="platformApiUrl" placeholder="https://api.banxia.com/v1" required>
                            <div class="form-text">从外卖平台获取的API基础地址，用于发送订单</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">API Key</label>
                                <input type="text" class="form-control" id="platformAppKey" placeholder="从外卖平台后台获取">
                                <div class="form-text">由外卖平台提供，用于身份标识</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">API Secret</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="platformAppSecret" placeholder="从外卖平台后台获取">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleSecretVisibility()">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">由外卖平台提供，用于签名验证</div>
                            </div>
                        </div>
                        <div class="d-grid mb-3">
                            <button class="btn btn-primary" type="button" onclick="showApiCredentials()">
                                <i class="bi bi-key"></i> 显示完整API接入凭证
                            </button>
                        </div>
                        <div class="alert alert-warning mb-3">
                            <h6><i class="bi bi-info-circle"></i> 配置说明</h6>
                            <hr>
                            <p class="mb-2">奶茶后台作为客户端，会主动调用外卖平台的API发送订单。</p>
                            <p class="mb-1">请将以下<strong>回调地址</strong>提供给外卖平台，用于接收订单状态通知：</p>
                            <div class="input-group">
                                <span class="input-group-text">状态回调</span>
                                <input type="text" class="form-control" id="callbackUrl" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyCallbackUrl('callback')">
                                    <i class="bi bi-clipboard"></i> 复制
                                </button>
                            </div>
                            <div class="form-text mt-2">
                                <strong>奶茶后台调用的外卖平台API：</strong><br>
                                • 发送订单: POST /api/external/order/receive<br>
                                • 查询状态: GET /api/external/order/status<br>
                                • 取消订单: POST /api/external/order/cancel
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">IP白名单</label>
                            <input type="text" class="form-control" id="platformIpWhitelist" placeholder="192.168.1.100, 192.168.1.101, 10.0.0.*">
                            <div class="form-text">多个IP用逗号分隔，支持通配符如 192.168.1.*，留空表示允许所有IP</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">限流配置（每分钟最大请求数）</label>
                                <input type="number" class="form-control" id="platformRateLimit" value="100" min="1" max="10000">
                                <div class="form-text">限制该平台的API请求频率，防止恶意调用</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">商户ID</label>
                                <input type="text" class="form-control" id="platformMerchantId" placeholder="配送平台分配的商户ID">
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="platformIsActive" checked>
                                <label class="form-check-label" for="platformIsActive">启用此平台</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="savePlatform()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let platforms = [];
        let platformModal = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            platformModal = new bootstrap.Modal(document.getElementById('platformModal'));
            loadPlatforms();
        });
        
        // 生成随机字符串
        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // 根据平台名称生成代码
        function generatePlatformCode() {
            const nameInput = document.getElementById('platformName');
            const codeInput = document.getElementById('platformCode');
            
            // 如果代码字段已有值且不是新建状态，不自动填充
            if (codeInput.value && document.getElementById('platformId').value) {
                return;
            }
            
            const name = nameInput.value.trim();
            if (!name) return;
            
            // 将中文转换为拼音风格的代码
            const code = name
                .toLowerCase()
                .replace(/[^\w\s\u4e00-\u9fa5]/g, '')
                .replace(/[\s]+/g, '_')
                .substring(0, 20);
            
            // 如果是纯中文，生成一个随机代码
            if (/^[\u4e00-\u9fa5]+$/.test(name)) {
                const pinyinMap = {
                    '美团': 'meituan', '饿了么': 'eleme', '顺丰': 'shunfeng',
                    '京东': 'jd', '达达': 'dada', '闪送': 'shansong'
                };
                for (let key in pinyinMap) {
                    if (name.includes(key)) {
                        codeInput.value = pinyinMap[key];
                        return;
                    }
                }
                codeInput.value = 'platform_' + generateRandomString(6);
            } else {
                codeInput.value = code;
            }
        }
        
        // 切换Secret显示/隐藏
        function toggleSecretVisibility() {
            const input = document.getElementById('platformAppSecret');
            const icon = event.currentTarget.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        }
        
        // 平台类型切换
        function onPlatformTypeChange() {
            const platformType = document.getElementById('platformType').value;
            const baseUrl = window.location.origin;
            
            if (platformType === 'food_delivery') {
                // 外卖平台模式
                document.getElementById('platformTypeHelp').textContent = '向外卖平台发送订单';
            } else {
                // 配送平台模式
                document.getElementById('platformTypeHelp').textContent = '向配送平台发送配送订单';
            }
            
            // 更新回调地址 - 统一的回调接口
            document.getElementById('callbackUrl').value = `${baseUrl}/api/delivery/callback`;
        }
        
        // 复制回调地址
        function copyCallbackUrl(type) {
            if (type !== 'callback') return;
            const url = document.getElementById('callbackUrl').value;
            navigator.clipboard.writeText(url).then(() => {
                showToast('回调地址已复制', 'success');
            }).catch(() => {
                showToast('复制失败', 'error');
            });
        }
        
        // 加载平台列表
        async function loadPlatforms() {
            try {
                const response = await fetch('/api/delivery-platforms/all');
                const data = await response.json();
                
                if (data.success) {
                    platforms = data.platforms;
                    renderPlatforms();
                } else {
                    showToast('加载失败：' + data.message, 'error');
                }
            } catch (error) {
                console.error('加载外卖平台列表失败:', error);
                showToast('加载失败', 'error');
            }
        }
        
        // 渲染平台列表
        function renderPlatforms() {
            const tbody = document.getElementById('platformsTableBody');
            
            if (platforms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">暂无外卖平台数据</td></tr>';
                return;
            }
            
            tbody.innerHTML = platforms.map(platform => `
                <tr>
                    <td>${platform.sort_order}</td>
                    <td>
                        ${platform.icon 
                            ? `<img src="${platform.icon}" alt="${platform.name}" class="platform-icon">`
                            : `<div class="platform-icon-placeholder"><i class="bi bi-truck"></i></div>`
                        }
                    </td>
                    <td><strong>${platform.name}</strong></td>
                    <td><code>${platform.code}</code></td>
                    <td>
                        ${platform.web_url 
                            ? `<a href="${platform.web_url}" target="_blank" class="text-truncate d-inline-block" style="max-width: 150px;">${platform.web_url}</a>`
                            : '<span class="text-muted">-</span>'
                        }
                    </td>
                    <td>
                        ${platform.app_url 
                            ? `<span class="text-truncate d-inline-block" style="max-width: 150px;" title="${platform.app_url}">${platform.app_url}</span>`
                            : '<span class="text-muted">-</span>'
                        }
                    </td>
                    <td>
                        <span class="badge ${platform.is_active ? 'bg-success' : 'bg-danger'}">
                            ${platform.is_active ? '启用' : '禁用'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick='openEditModal(${JSON.stringify(platform).replace(/'/g, "&#39;")})' title="编辑">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="testSignature(${platform.id})" title="测试签名">
                                <i class="bi bi-key"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deletePlatform(${platform.id})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // 打开添加模态框
        function openAddModal() {
            document.getElementById('platformForm').reset();
            document.getElementById('platformId').value = '';
            document.getElementById('modalTitle').textContent = '添加外卖平台';
            platformModal.show();
        }
        
        // 打开编辑模态框
        function openEditModal(platform) {
            document.getElementById('platformId').value = platform.id;
            document.getElementById('platformName').value = platform.name;
            document.getElementById('platformCode').value = platform.code;
            document.getElementById('platformType').value = platform.platform_type || 'third_party';
            document.getElementById('platformIcon').value = platform.icon || '';
            document.getElementById('platformSort').value = platform.sort_order;
            document.getElementById('platformWebUrl').value = platform.web_url || '';
            document.getElementById('platformAppUrl').value = platform.app_url || '';
            document.getElementById('platformApiUrl').value = platform.api_url || '';
            document.getElementById('platformMerchantId').value = platform.merchant_id || '';
            document.getElementById('platformAppKey').value = platform.app_key || '';
            document.getElementById('platformAppSecret').value = platform.app_secret || '';
            document.getElementById('platformIpWhitelist').value = platform.ip_whitelist || '';
            document.getElementById('platformRateLimit').value = platform.rate_limit || 100;
            document.getElementById('platformIsActive').checked = platform.is_active;
            
            // 触发类型切换以更新UI（包括回调地址）
            onPlatformTypeChange();
            
            document.getElementById('modalTitle').textContent = '编辑外卖平台';
            platformModal.show();
        }
        
        // 显示API接入凭证
        function showApiCredentials() {
            const platformCode = document.getElementById('platformCode').value;
            const platformName = document.getElementById('platformName').value;
            const apiKey = document.getElementById('platformAppKey').value;
            const apiSecret = document.getElementById('platformAppSecret').value;
            
            if (!platformCode || !apiKey || !apiSecret) {
                showToast('请先填写平台代码、API Key和API Secret', 'warning');
                return;
            }
            
            const credentialsHtml = `
                <div class="alert alert-info">
                    <h6><i class="bi bi-key"></i> API接入凭证（请妥善保管）</h6>
                    <hr>
                    <div class="mb-2">
                        <strong>平台代码：</strong>
                        <code>${platformCode}</code>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${platformCode}')">复制</button>
                    </div>
                    <div class="mb-2">
                        <strong>API密钥：</strong>
                        <code>${apiKey}</code>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${apiKey}')">复制</button>
                    </div>
                    <div class="mb-2">
                        <strong>API Secret：</strong>
                        <code>${apiSecret}</code>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${apiSecret}')">复制</button>
                    </div>
                </div>
                <div class="alert alert-warning">
                    <small>请妥善保管以上凭证信息，不要泄露给他人。</small>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = `
                <div class="modal fade" id="credentialsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">API接入凭证 - ${platformName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${credentialsHtml}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modalDiv);
            
            const modal = new bootstrap.Modal(document.getElementById('credentialsModal'));
            modal.show();
            
            document.getElementById('credentialsModal').addEventListener('hidden.bs.modal', function() {
                modalDiv.remove();
            });
        }
        
        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('已复制', 'success');
            }).catch(() => {
                showToast('复制失败', 'error');
            });
        }
        
        // 显示API接入文档
        function showApiDocs() {
            const platformCode = document.getElementById('platformCode').value;
            const platformType = document.getElementById('platformType').value;
            const baseUrl = window.location.origin;
            const apiKey = document.getElementById('platformAppKey').value;
            const apiSecret = document.getElementById('platformAppSecret').value;
            
            let docsHtml = '';
            
            if (platformType === 'food_delivery') {
                // 外卖平台接入文档
                docsHtml = `
                    <div class="alert alert-info">
                        <h6>API接入凭证（外卖平台调用奶茶店）</h6>
                        <hr>
                        <p><strong>平台代码：</strong><code>${platformCode}</code></p>
                        <p><strong>API Key：</strong><code>${apiKey}</code></p>
                        <p><strong>API Secret：</strong><code>${apiSecret}</code></p>
                    </div>
                    <h6>API接口列表</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>接口</th>
                                    <th>地址</th>
                                    <th>说明</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="badge bg-success">POST</span></td>
                                    <td><code>/api/delivery/${platformCode}/order</code></td>
                                    <td>推送外卖订单</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-primary">GET</span></td>
                                    <td><code>/api/delivery/${platformCode}/order/{orderNo}</code></td>
                                    <td>查询订单状态</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-success">POST</span></td>
                                    <td><code>/api/delivery/${platformCode}/order/{orderNo}/cancel</code></td>
                                    <td>取消订单</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-success">POST</span></td>
                                    <td><code>/api/delivery/${platformCode}/order/{orderNo}/confirm</code></td>
                                    <td>确认订单</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-primary">GET</span></td>
                                    <td><code>/api/delivery/${platformCode}/stores</code></td>
                                    <td>获取店铺列表</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <hr>
                    <h6>签名算法</h6>
                    <pre class="bg-light p-2 rounded"><code>1. 将所有参数（除sign外，排除数组/对象）按key排序
2. 拼接成字符串：key1=value1&key2=value2...
3. 使用 HMAC-SHA256 签名，密钥为 API Secret
4. 将签名结果放入 sign 参数</code></pre>
                `;
            } else {
                // 配送平台接入文档
                docsHtml = `
                    <div class="alert alert-info">
                        <h6>API接入凭证（奶茶店调用配送平台）</h6>
                        <hr>
                        <p><strong>平台代码：</strong><code>${platformCode}</code></p>
                        <p><strong>API Key：</strong><code>${apiKey}</code></p>
                        <p><strong>API Secret：</strong><code>${apiSecret}</code></p>
                    </div>
                    <h6>回调地址（奶茶店接收配送状态）</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>事件</th>
                                    <th>回调地址</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>订单状态变更</td>
                                    <td><code>/api/callback/delivery/${platformCode}/order-status</code></td>
                                </tr>
                                <tr>
                                    <td>骑手位置更新</td>
                                    <td><code>/api/callback/delivery/${platformCode}/rider-location</code></td>
                                </tr>
                                <tr>
                                    <td>配送异常</td>
                                    <td><code>/api/callback/delivery/${platformCode}/exception</code></td>
                                </tr>
                                <tr>
                                    <td>订单取消</td>
                                    <td><code>/api/callback/delivery/${platformCode}/order-cancelled</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <hr>
                    <h6>签名算法</h6>
                    <pre class="bg-light p-2 rounded"><code>1. 将所有参数（除sign外，排除数组/对象）按key排序
2. 拼接成字符串：key1=value1&key2=value2...
3. 使用 HMAC-SHA256 签名，密钥为 API Secret
4. 将签名结果放入 sign 参数</code></pre>
                `;
            }
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = `
                <div class="modal fade" id="apiDocsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">API接入文档 - ${document.getElementById('platformName').value}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${docsHtml}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary" onclick="copyApiInfo()">复制接入信息</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modalDiv);
            
            const modal = new bootstrap.Modal(document.getElementById('apiDocsModal'));
            modal.show();
            
            document.getElementById('apiDocsModal').addEventListener('hidden.bs.modal', function() {
                modalDiv.remove();
            });
        }
        
        // 复制API接入信息
        function copyApiInfo() {
            const platformCode = document.getElementById('platformCode').value;
            const platformName = document.getElementById('platformName').value;
            const apiKey = document.getElementById('platformAppKey').value;
            const apiSecret = document.getElementById('platformAppSecret').value;
            const callbackUrl = document.getElementById('callbackUrl').value;
            const apiUrl = document.getElementById('platformApiUrl').value;
            
            const info = `${platformName} 接入信息：
平台代码：${platformCode}
API Key：${apiKey}
API Secret：${apiSecret}
外卖平台API：${apiUrl}
状态回调地址：${callbackUrl}

请妥善保管以上凭证信息。`;
            
            navigator.clipboard.writeText(info).then(() => {
                showToast('已复制到剪贴板', 'success');
            }).catch(() => {
                showToast('复制失败', 'error');
            });
        }
        
        // 保存平台
        async function savePlatform() {
            const id = document.getElementById('platformId').value;
            const platformData = {
                name: document.getElementById('platformName').value,
                code: document.getElementById('platformCode').value,
                platform_type: document.getElementById('platformType').value,
                icon: document.getElementById('platformIcon').value,
                sort_order: parseInt(document.getElementById('platformSort').value) || 0,
                web_url: document.getElementById('platformWebUrl').value,
                app_url: document.getElementById('platformAppUrl').value,
                api_url: document.getElementById('platformApiUrl').value,
                merchant_id: document.getElementById('platformMerchantId').value,
                app_key: document.getElementById('platformAppKey').value,
                app_secret: document.getElementById('platformAppSecret').value,
                callback_url: document.getElementById('callbackUrl').value,
                ip_whitelist: document.getElementById('platformIpWhitelist').value,
                rate_limit: parseInt(document.getElementById('platformRateLimit').value) || 100,
                is_active: document.getElementById('platformIsActive').checked
            };
            
            // 验证必填字段
            if (!platformData.name || !platformData.code) {
                showToast('请填写平台名称和代码', 'error');
                return;
            }
            
            try {
                const url = id ? `/api/delivery-platforms/${id}` : '/api/delivery-platforms';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(platformData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(id ? '更新成功' : '创建成功', 'success');
                    platformModal.hide();
                    loadPlatforms();
                } else {
                    showToast(data.message || '操作失败', 'error');
                }
            } catch (error) {
                console.error('保存外卖平台失败:', error);
                showToast('保存失败', 'error');
            }
        }
        
        // 删除平台
        async function deletePlatform(id) {
            if (!confirm('确定要删除这个外卖平台吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/delivery-platforms/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('删除成功', 'success');
                    loadPlatforms();
                } else {
                    showToast(data.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除外卖平台失败:', error);
                showToast('删除失败', 'error');
            }
        }
        
        // 测试签名生成
        async function testSignature(platformId) {
            try {
                const response = await fetch(`/api/delivery-platforms/${platformId}/test-signature`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 显示签名测试结果
                    const resultHtml = `
                        <div class="alert alert-success">
                            <h6>签名生成成功</h6>
                            <hr>
                            <p><strong>API地址:</strong> <code>${data.data.apiUrl}</code></p>
                            <p><strong>时间戳:</strong> ${data.data.params.timestamp}</p>
                            <p><strong>签名:</strong> <code style="word-break: break-all;">${data.data.sign}</code></p>
                            <hr>
                            <p class="mb-0"><strong>请求参数:</strong></p>
                            <pre class="bg-light p-2 rounded"><code>${JSON.stringify(data.data.params, null, 2)}</code></pre>
                        </div>
                    `;
                    
                    // 创建临时模态框显示结果
                    const modalDiv = document.createElement('div');
                    modalDiv.innerHTML = `
                        <div class="modal fade" id="signatureResultModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">签名测试结果</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        ${resultHtml}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modalDiv);
                    
                    const modal = new bootstrap.Modal(document.getElementById('signatureResultModal'));
                    modal.show();
                    
                    // 模态框关闭后移除元素
                    document.getElementById('signatureResultModal').addEventListener('hidden.bs.modal', function() {
                        modalDiv.remove();
                    });
                } else {
                    showToast(data.message || '测试失败', 'error');
                }
            } catch (error) {
                console.error('测试签名失败:', error);
                showToast('测试签名失败', 'error');
            }
        }
        
        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
