<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奶茶店后台管理系统 - 用户管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/admin-modern.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            color: white;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
        }
        .sidebar a:hover {
            background-color: #495057;
        }
        .content {
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
        }
        .table th {
            white-space: nowrap;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .active-status {
            background-color: #28a745;
            color: white;
        }
        .inactive-status {
            background-color: #dc3545;
            color: white;
        }
        .points-display {
            line-height: 1.6;
        }
        .points-value {
            font-weight: 600;
            font-size: 16px;
            color: #007bff;
        }
        .points-section {
            padding: 8px;
            border-radius: 6px;
            background-color: #f8f9fa;
            margin-bottom: 8px;
        }
        .points-section:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-2 sidebar">
                <div class="p-3 text-center" style="background-color: #212529;">
                    <h5 class="mb-0">奶茶店管理系统</h5>
                </div>
                <ul class="nav flex-column p-3">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-house"></i> 首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/products">
                            <i class="bi bi-box"></i> 商品管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/recommendations">
                            <i class="bi bi-star"></i> 商品推荐
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/pos">
                            <i class="bi bi-shop"></i> 现场点单
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/orders">
                            <i class="bi bi-phone"></i> 小程序订单
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/all-orders">
                            <i class="bi bi-cart"></i> 订单管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/users">
                            <i class="bi bi-people-fill"></i> 用户管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/members">
                            <i class="bi bi-people"></i> 会员管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/coupons">
                            <i class="bi bi-ticket"></i> 优惠券管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/stores">
                            <i class="bi bi-building"></i> 店铺管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/recharge">
                            <i class="bi bi-wallet2"></i> 储值管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/group-buy">
                            <i class="bi bi-people-fill"></i> 团购管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/ui">
                            <i class="bi bi-palette-fill"></i> UI管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/delivery-platforms">
                            <i class="bi bi-truck"></i> 外卖平台
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/stats">
                            <i class="bi bi-bar-chart"></i> 数据统计
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="/admin/logout">
                            <i class="bi bi-box-arrow-right"></i> 退出登录
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- 主内容区 -->
            <div class="col-md-10 content">
                <!-- 顶部导航栏 -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
                    <div class="container-fluid d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="bi bi-people-fill"></i> 用户管理</h4>
                        <span class="text-muted">欢迎，<strong>admin</strong></span>
                    </div>
                </nav>
                
                <!-- 用户管理页面 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">用户管理</h5>
                        <div class="d-flex">
                            <input type="text" class="form-control me-2" id="searchInput" placeholder="搜索用户（昵称/手机号）" style="width: 200px;">
                            <select class="form-select me-2" id="statusFilter" style="width: 120px; min-width: 120px;">
                                <option value="">所有状态</option>
                                <option value="1">已激活</option>
                                <option value="0">未激活</option>
                            </select>
                            <button class="btn btn-primary" onclick="loadUsers()">
                                <i class="bi bi-search"></i> 搜索
                            </button>
                            <button class="btn btn-secondary ms-2" onclick="resetFilters()">
                                <i class="bi bi-arrow-counterclockwise"></i> 重置
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 用户列表 -->
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>用户信息</th>
                                        <th>手机号</th>
                                        <th>会员等级</th>
                                        <th>
                                            <div>可消费积分</div>
                                            <div class="text-muted small fw-normal">累计成长值</div>
                                        </th>
                                        <th>余额</th>
                                        <th>优惠券</th>
                                        <th>状态</th>
                                        <th>注册时间</th>
                                        <th>最后登录</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- 动态加载用户列表 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页 -->
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- 动态加载分页-->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑用户模态框 -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">编辑用户信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="bi bi-info-circle-fill flex-shrink-0 me-2"></i>
                            <div>
                                <strong>积分和成长值说明：</strong><br>
                                <small>
                                    • <strong>可消费积分/strong>：用户可以使用的积分，可用于兑换优惠券或商品<br>
                                    • <strong>累计成长值/strong>：累计的成长总值，用于决定会员等级提升
                                </small>
                            </div>
                        </div>
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editNickname" class="form-label">昵称</label>
                            <input type="text" class="form-control" id="editNickname">
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">手机号</label>
                            <input type="text" class="form-control" id="editPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editAvatarUrl" class="form-label">头像URL</label>
                            <input type="text" class="form-control" id="editAvatarUrl" placeholder="输入头像图片URL">
                        </div>
                        <div class="mb-3">
                            <label for="editMemberLevel" class="form-label">会员等级</label>
                            <select class="form-select" id="editMemberLevel">
                                <!-- 动态加载会员等级-->
                            </select>
                        </div>
                        <div class="points-section">
                            <label for="editPoints" class="form-label mb-1">
                                <i class="bi bi-coin text-warning"></i> 可消费积分                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-coin"></i></span>
                                <input type="number" class="form-control" id="editPoints" min="0" placeholder="0" value="0">
                            </div>
                            <div class="form-text mt-1">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 用户可用于兑换优惠券或商品的积分余额
                                </small>
                            </div>
                        </div>
                        <div class="points-section">
                            <label for="editGrowthValue" class="form-label mb-1">
                                <i class="bi bi-graph-up-arrow text-primary"></i> 累计成长值                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-graph-up-arrow"></i></span>
                                <input type="number" class="form-control" id="editGrowthValue" min="0" placeholder="0" value="0">
                            </div>
                            <div class="form-text mt-1">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 决定会员等级的累计成长值（普通、白银1000、黄金5000、白金10000、钻石50000）�?                                </small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editBalance" class="form-label">余额</label>
                            <input type="number" step="0.01" class="form-control" id="editBalance">
                        </div>
                        <div class="mb-3">
                            <label for="editStatus" class="form-label">状态</label>
                            <select class="form-select" id="editStatus">
                                <option value="1">已激活/option>
                                <option value="0">未激活/option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserChanges()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 引入Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let memberLevels = [];
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadMemberLevels();
            loadUsers();
        });
        
        // 加载会员等级
        async function loadMemberLevels() {
            try {
                const response = await fetch('/api/member-levels');
                const data = await response.json();
                if (Array.isArray(data)) {
                    memberLevels = data;
                    populateMemberLevelSelect();
                }
            } catch (error) {
                console.error('加载会员等级失败:', error);
            }
        }
        
        // 填充会员等级下拉框
        function populateMemberLevelSelect() {
            const select = document.getElementById('editMemberLevel');
            select.innerHTML = '';

            memberLevels.forEach(level => {
                const option = document.createElement('option');
                option.value = level.level_id;
                option.textContent = `${level.name} (${level.growth_required}成长值)`;
                select.appendChild(option);
            });
        }
        
        // 加载用户列表
        async function loadUsers(page = 1) {
            try {
                const search = document.getElementById('searchInput').value;
                const status = document.getElementById('statusFilter').value;
                const url = `/api/users?page=${page}&limit=10&search=${encodeURIComponent(search)}&status=${status}`;

                console.log('========== 前端：开始加载用户列表 ==========');
                console.log('请求URL:', url);
                console.log('请求参数:', { page, search, status });

                const response = await fetch(url);
                console.log('响应状态:', response.status, response.statusText);

                const data = await response.json();
                console.log('响应数据:', data);

                if (data.success) {
                    console.log('成功获取用户数据，用户数量:', data.data ? data.data.length : 0);
                    console.log('第一个用户数据:', data.data && data.data.length > 0 ? data.data[0] : '无数据');
                    renderUsers(data.data);
                    currentPage = data.page;
                    totalPages = data.totalPages;
                    renderPagination();
                    console.log('========== 前端：用户列表加载完成 ==========');
                } else {
                    console.error('API返回失败:', data);
                    alert('加载用户列表失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                console.error('========== 前端：加载用户列表异常 ==========');
                console.error('错误详情:', error);
                alert('加载用户列表失败，请检查网络连接');
            }
        }
        
        // 渲染用户列表
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');

                // 获取可消费积分、成长值、余额和优惠券数量
                const points = user.points || 0;
                const growthValue = user.totalPoints || 0;
                const balance = parseFloat(user.balance || 0).toFixed(2);
                const couponCount = user.couponCount || 0;

                // 查找会员等级名称
                let levelName = '普通会员';
                if (user.level) {
                    const foundLevel = memberLevels.find(level => level.level_id === user.level);
                    if (foundLevel) {
                        levelName = foundLevel.name;
                    } else {
                        // 默认映射作为备份
                        const defaultLevelMap = {
                            'normal': '普通会员',
                            'silver': '白银会员',
                            'gold': '黄金会员',
                            'platinum': '白金会员',
                            'diamond': '钻石会员'
                        };
                        levelName = defaultLevelMap[user.level] || user.level;
                    }
                }

                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${user.avatarUrl && user.avatarUrl.trim() && !user.avatarUrl.includes('example.com') ? `<img src="${user.avatarUrl}" alt="头像" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">` : `<i class="bi bi-person-circle" style="font-size: 40px; margin-right: 10px;"></i>`}
                            <div>
                                <div><strong>${user.nickName || '未设置昵称'}</strong></div>
                                <div class="text-muted small">OpenID: ${user.openid?.substring(0, 8) || '未绑定'}</div>
                                <div class="text-muted small">会员： ${user.memberNo || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.phone || '未绑定手机号'}</td>
                    <td>
                        <span class="badge bg-info">
                            ${levelName}
                        </span>
                    </td>
                    <td>
                        <div class="points-display">
                            <div class="mb-1">
                                <i class="bi bi-coin text-warning"></i>
                                <strong class="ms-1">${points}</strong>
                                <span class="text-muted small">可消费</span>
                            </div>
                            <div>
                                <i class="bi bi-graph-up-arrow text-primary"></i>
                                <strong class="ms-1">${growthValue}</strong>
                                <span class="text-muted small">成长值</span>
                            </div>
                        </div>
                    </td>
                    <td>¥${balance}</td>
                    <td>
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-ticket-perforated"></i> ${couponCount} 张
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${user.is_active ? 'active-status' : 'inactive-status'}">
                            ${user.is_active ? '已激活' : '未激活'}
                        </span>
                    </td>
                    <td>${user.createdAt ? new Date(user.createdAt).toLocaleString() : '-'}</td>
                    <td>${user.last_login_at ? new Date(user.last_login_at).toLocaleString() : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${user.id})">
                            <i class="bi bi-pencil"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteUser(${user.id})">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 渲染分页
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadUsers(${currentPage - 1})">&laquo;</a>`;
            pagination.appendChild(prevLi);

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="loadUsers(${i})"></a>`;
                const pageLink = li.querySelector('.page-link');
                pageLink.textContent = i;
                pagination.appendChild(li);
            }

            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadUsers(${currentPage + 1})">&raquo;</a>`;
            pagination.appendChild(nextLi);
        }
        
        // 打开编辑模态框
        async function openEditModal(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`);
                const data = await response.json();

                if (data.success) {
                    const user = data.data;
                    document.getElementById('editUserId').value = user.id;
                    // 直接使用后端返回的前端字段名
                    document.getElementById('editNickname').value = user.nickName || '';
                    document.getElementById('editPhone').value = user.phone || '';
                    document.getElementById('editAvatarUrl').value = user.avatarUrl || '';
                    document.getElementById('editMemberLevel').value = user.level || 'normal';
                    // totalPoints 是成长值，points 是可消费积分
                    document.getElementById('editGrowthValue').value = user.totalPoints || 0;
                    document.getElementById('editPoints').value = user.points || 0;
                    document.getElementById('editBalance').value = parseFloat(user.balance || 0).toFixed(2);
                    document.getElementById('editStatus').value = user.is_active ? 1 : 0;

                    console.log('加载用户数据:', {
                        points: user.points,
                        totalPoints: user.totalPoints,
                        balance: user.balance
                    });

                    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('获取用户详情失败:', error);
            }
        }
        
        // 保存用户修改
        async function saveUserChanges() {
            try {
                const userId = document.getElementById('editUserId').value;

                // 验证输入
                const points = parseInt(document.getElementById('editPoints').value) || 0;
                const growthValue = parseInt(document.getElementById('editGrowthValue').value) || 0;
                const balance = parseFloat(document.getElementById('editBalance').value) || 0;

                if (points < 0 || growthValue < 0 || balance < 0) {
                    alert('积分、成长值和余额不能为负数！');
                    return;
                }

                const userData = {
                    nickName: document.getElementById('editNickname').value,
                    phone: document.getElementById('editPhone').value,
                    avatarUrl: document.getElementById('editAvatarUrl').value,
                    level: document.getElementById('editMemberLevel').value,
                    growth_value: growthValue,  // 成长值
                    points: points,  // 可消费积分
                    balance: balance,
                    is_active: parseInt(document.getElementById('editStatus').value)
                };

                console.log('保存用户数据:', userData);

                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                    modal.hide();
                    loadUsers(currentPage);
                    alert('用户信息更新成功');
                } else {
                    alert('更新失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                console.error('更新用户信息失败:', error);
                alert('更新用户信息失败，请重试');
            }
        }
        
        // 删除用户
        async function deleteUser(userId) {
            if (confirm('确定要删除这个用户吗？')) {
                try {
                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        loadUsers(currentPage);
                        alert('用户删除成功');
                    }
                } catch (error) {
                    console.error('删除用户失败:', error);
                    alert('删除用户失败，请重试');
                }
            }
        }
        
        // 搜索用户
        function searchUsers() {
            loadUsers(1);
        }
        
        // 重置筛选
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            loadUsers(1);
        }

        // 回车键搜索
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadUsers(1);
            }
        });

        // 状态筛选
        document.getElementById('statusFilter').addEventListener('change', function() {
            loadUsers(1);
        });
    </script>
</body>
</html>
