# 奶茶店小程序后端部署说明

## 快速部署步骤

### 1. 上传文件到服务器

在 PowerShell 中执行以下命令：

```powershell
# 进入后端目录
cd "F:\奶茶店小程序\后台\backend"

# 上传修改的文件（逐个上传）
scp app.js root@39.102.214.230:/opt/milktea-backend/
scp package.json root@39.102.214.230:/opt/milktea-backend/

# 上传目录（如果有修改）
scp -r controllers root@39.102.214.230:/opt/milktea-backend/
scp -r routes root@39.102.214.230:/opt/milktea-backend/
scp -r models root@39.102.214.230:/opt/milktea-backend/
scp -r utils root@39.102.214.230:/opt/milktea-backend/
```

### 2. 登录服务器重启服务

```powershell
# SSH 登录服务器
ssh root@39.102.214.230

# 进入项目目录
cd /opt/milktea-backend

# 安装依赖（如果 package.json 有修改）
npm install

# 重启服务
pm2 restart milktea-backend

# 或者如果没有使用 pm2
npm start
```

### 3. 验证部署

```powershell
# 测试线上服务
curl http://39.102.214.230:3000/api/health
```

## 使用自动化脚本部署

### 方式 1：运行 PowerShell 脚本

```powershell
# 在 PowerShell 中执行
.\deploy.ps1
```

### 方式 2：使用 Git 部署（如果服务器已配置 Git）

```powershell
# 1. 本地提交代码
git add .
git commit -m "更新后端代码"
git push

# 2. 服务器拉取代码
ssh root@39.102.214.230 "cd /opt/milktea-backend && git pull && npm install && pm2 restart milktea-backend"
```

## 需要同步的文件清单

根据您的修改，选择需要上传的文件：

- [ ] `app.js` - 主入口文件
- [ ] `package.json` - 依赖配置（如果有新依赖）
- [ ] `controllers/` - 控制器（业务逻辑修改）
- [ ] `routes/` - 路由（API 接口修改）
- [ ] `models/` - 数据模型（数据库相关修改）
- [ ] `utils/` - 工具函数
- [ ] `middleware/` - 中间件
- [ ] `config/` - 配置文件

**不需要上传的文件：**
- `node_modules/` - 在服务器上执行 `npm install` 自动生成
- `database.sqlite` - 服务器上的数据库文件
- `.git/` - Git 版本控制文件
- `uploads/` - 上传的文件

## 常见问题

### 1. 连接被拒绝
```
ssh: connect to host 39.102.214.230 port 22: Connection refused
```
**解决：** 检查服务器是否开启 SSH 服务，或防火墙是否允许 22 端口

### 2. 权限不足
```
Permission denied
```
**解决：** 确认使用 root 用户或具有 sudo 权限的用户

### 3. 服务启动失败
```
Error: Cannot find module 'xxx'
```
**解决：** 执行 `npm install` 安装缺失的依赖

## 一键部署命令

如果您已经配置好 SSH 密钥，可以使用以下一键命令：

```powershell
# 上传所有文件并重启服务
scp -r app.js package.json controllers routes models utils middleware config root@39.102.214.230:/opt/milktea-backend/ && ssh root@39.102.214.230 "cd /opt/milktea-backend && npm install && pm2 restart milktea-backend"
```
