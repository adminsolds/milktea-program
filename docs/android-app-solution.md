# 奶茶店安卓 APP 解决方案

## 方案概述

开发独立的安卓 APP，替代浏览器端的现场点单功能，深度集成美团点餐机硬件，提供更好的用户体验和打印支持。

## 核心优势

1. **硬件深度集成** - 直接调用打印机、扫码枪、钱箱等硬件
2. **离线可用** - 网络不稳定时仍可正常使用
3. **性能更好** - 原生应用比浏览器更流畅
4. **体验更佳** - 专为触屏优化，操作更便捷
5. **打印稳定** - 绕过浏览器限制，直接控制打印机

---

## 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                    安卓 APP (Kotlin/Java)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   现场点单    │  │   订单管理    │  │   数据统计    │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   会员管理    │  │   商品管理    │  │   打印设置    │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
├─────────────────────────────────────────────────────────────┤
│  硬件适配层 (Hardware Adapter)                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ USB打印   │ │ 扫码枪   │ │ 钱箱     │ │ 客显屏   │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
├─────────────────────────────────────────────────────────────┤
│  数据层 (Data Layer)                                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                    │
│  │ Room DB  │ │ Retrofit │ │ WebSocket│                    │
│  │ (本地)   │ │ (API)    │ │ (实时)   │                    │
│  └──────────┘ └──────────┘ └──────────┘                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    后端服务器 (Node.js)                       │
│              39.102.214.230:3000                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 功能模块设计

### 1. 现场点单模块

#### 功能列表
- 商品浏览（分类展示、搜索）
- 购物车管理
- 规格选择（糖度、冰度、配料）
- 会员识别（手机号/扫码）
- 优惠计算（会员折扣、优惠券）
- 支付处理（现金、微信、支付宝、储值）
- 订单提交

#### 页面结构
```
现场点单
├── 商品选择页
│   ├── 顶部：搜索栏、会员输入
│   ├── 左侧：商品分类
│   ├── 右侧：商品网格
│   └── 底部：购物车悬浮按钮
│
├── 购物车页
│   ├── 商品列表
│   ├── 会员信息
│   ├── 优惠明细
│   └── 结算按钮
│
├── 规格选择弹窗
│   ├── 规格选项
│   ├── 糖度选择
│   ├── 冰度选择
│   └── 配料选择
│
└── 支付页
    ├── 订单金额
    ├── 支付方式
    └── 确认支付
```

### 2. 订单管理模块

#### 功能列表
- 订单列表（待制作、制作中、已完成）
- 订单详情
- 订单状态更新
- 订单搜索
- 订单筛选
- 重新打印

#### 页面结构
```
订单管理
├── 订单列表页
│   ├── Tab切换（待制作/制作中/已完成）
│   ├── 订单卡片
│   └── 搜索/筛选
│
└── 订单详情页
    ├── 订单信息
    ├── 商品列表
    ├── 操作按钮（制作完成/重新打印）
    └── 退款处理
```

### 3. 打印管理模块

#### 功能列表
- 打印机设置（USB/网络）
- 打印模板配置
- 打印测试
- 打印队列管理
- 自动打印开关

#### 页面结构
```
打印管理
├── 打印机列表
│   ├── USB打印机
│   └── 网络打印机
│
├── 打印设置
│   ├── 小票模板
│   ├── 标签模板
│   ├── 自动打印
│   └── 打印份数
│
└── 打印测试
    ├── 测试小票
    └── 测试标签
```

### 4. 会员管理模块

#### 功能列表
- 会员查询
- 会员注册
- 会员充值
- 消费记录
- 积分管理

#### 页面结构
```
会员管理
├── 会员列表
│   ├── 搜索栏
│   └── 会员卡片
│
├── 会员详情
│   ├── 基本信息
│   ├── 余额/积分
│   ├── 消费记录
│   └── 充值按钮
│
└── 会员注册/充值
    ├── 手机号输入
    ├── 验证码
    └── 充值金额
```

### 5. 数据统计模块

#### 功能列表
- 今日营业统计
- 订单统计
- 商品销量排行
- 支付方式统计
- 会员消费统计

#### 页面结构
```
数据统计
├── 今日概览
│   ├── 营业额
│   ├── 订单数
│   ├── 客单价
│   └── 会员消费
│
├── 订单统计
│   ├── 时段分布
│   ├── 类型分布
│   └── 趋势图表
│
└── 商品统计
    ├── 销量排行
    ├── 分类占比
    └── 热销商品
```

---

## 技术栈建议

### 开发语言
- **Kotlin**（推荐）- 现代、简洁、安全
- **Java** - 传统选择，生态成熟

### 开发框架
- **Jetpack Compose**（推荐）- 现代化UI框架，声明式编程
- **XML + ViewBinding** - 传统方式

### 架构模式
- **MVVM**（Model-View-ViewModel）- 推荐架构
- **Repository模式** - 数据管理
- **依赖注入** - Hilt/Koin

### 核心库

| 功能 | 库 | 说明 |
|------|-----|------|
| 网络请求 | Retrofit + OkHttp | REST API 通信 |
| 图片加载 | Coil/Glide | 商品图片加载 |
| 本地数据库 | Room | 离线数据存储 |
| 异步处理 | Kotlin Coroutines | 协程异步编程 |
| 打印控制 | ESC-POS 库 | USB/网络打印机 |
| 扫码 | ZXing/ML Kit | 二维码扫描 |
| 图表 | MPAndroidChart | 数据统计图表 |
| 依赖注入 | Hilt | 依赖管理 |

### 打印方案

#### USB 打印
```kotlin
// 使用 usb-serial-for-android 库
implementation 'com.github.mik3y:usb-serial-for-android:3.4.0'
```

#### 网络打印
```kotlin
// 使用 Socket 直接发送 ESC/POS 指令
val socket = Socket(printerIp, printerPort)
val outputStream = socket.getOutputStream()
outputStream.write(escPosCommands)
```

---

## 后端 API 设计

### 已有 API（直接使用）
- `GET /api/products` - 获取商品列表
- `POST /api/orders` - 创建订单
- `GET /api/orders/{id}` - 获取订单详情
- `GET /api/members/phone/{phone}` - 查询会员
- `POST /api/members` - 创建会员
- `POST /api/members/{id}/recharge` - 会员充值

### 需要新增的 API

#### 1. 实时订单推送
```
WebSocket: ws://39.102.214.230:3000/ws/orders

// 新订单推送
{
  "type": "new_order",
  "data": {
    "orderId": 123,
    "orderNo": "202602080001",
    "total": 28.00,
    "items": [...]
  }
}

// 订单状态更新
{
  "type": "status_update",
  "data": {
    "orderId": 123,
    "status": "preparing"
  }
}
```

#### 2. 批量获取订单
```
GET /api/orders/batch?status=pending&limit=50

Response:
{
  "success": true,
  "data": {
    "orders": [...],
    "total": 100
  }
}
```

#### 3. 今日统计
```
GET /api/statistics/today

Response:
{
  "success": true,
  "data": {
    "revenue": 2580.50,
    "orderCount": 86,
    "averageOrderValue": 30.00,
    "memberRevenue": 1500.00
  }
}
```

---

## 数据库设计（本地 Room）

### 实体类

```kotlin
// 商品表
@Entity(tableName = "products")
data class ProductEntity(
    @PrimaryKey val id: Int,
    val name: String,
    val price: Double,
    val image: String,
    val categoryId: Int,
    val isActive: Boolean,
    val updatedAt: Long
)

// 订单表
@Entity(tableName = "orders")
data class OrderEntity(
    @PrimaryKey val id: Int,
    val orderNo: String,
    val total: Double,
    val status: String,
    val paymentMethod: String,
    val createdAt: Long,
    val isSynced: Boolean  // 是否已同步到服务器
)

// 订单商品表
@Entity(tableName = "order_items")
data class OrderItemEntity(
    @PrimaryKey(autoGenerate = true) val id: Int = 0,
    val orderId: Int,
    val productId: Int,
    val productName: String,
    val quantity: Int,
    val price: Double,
    val spec: String?,
    val sugar: String?,
    val ice: String?,
    val toppings: String?
)

// 会员表
@Entity(tableName = "members")
data class MemberEntity(
    @PrimaryKey val id: Int,
    val phone: String,
    val name: String?,
    val balance: Double,
    val points: Int,
    val discount: Double,
    val updatedAt: Long
)
```

---

## 开发计划

### 第一阶段：基础功能（2-3周）
- [ ] 项目搭建和架构设计
- [ ] 网络层封装（Retrofit）
- [ ] 数据库设计（Room）
- [ ] 商品列表和搜索
- [ ] 购物车功能
- [ ] 基础下单流程

### 第二阶段：核心功能（2-3周）
- [ ] 会员管理
- [ ] 订单管理
- [ ] USB 打印集成
- [ ] 网络打印集成
- [ ] 扫码功能

### 第三阶段：完善优化（1-2周）
- [ ] 数据统计
- [ ] 离线模式
- [ ] 性能优化
- [ ] UI 美化
- [ ] 测试和 Bug 修复

### 第四阶段：部署上线（1周）
- [ ] 签名打包
- [ ] 美团点餐机安装测试
- [ ] 正式上线

---

## 成本估算

### 开发成本
- **开发周期**：6-8周
- **开发人员**：1-2人

### 技术成本
- 免费开源库（无额外费用）
- 无需第三方服务

---

## 与现有系统的集成

### 数据同步
```
APP ←→ 后端服务器 ←→ MySQL 数据库
```

### 打印流程
```
下单 → APP 生成 ESC/POS 指令 → USB/网络 → 打印机
```

### 会员系统
```
APP 和后端共用一套会员数据
```

---

## 优势对比

| 功能 | 浏览器方案 | 安卓 APP 方案 |
|------|-----------|--------------|
| 打印稳定性 | ⭐⭐ 依赖 WebUSB | ⭐⭐⭐⭐⭐ 原生支持 |
| 离线使用 | ❌ 必须联网 | ✅ 支持离线 |
| 硬件集成 | ⭐⭐ 受限 | ⭐⭐⭐⭐⭐ 深度集成 |
| 用户体验 | ⭐⭐⭐ 一般 | ⭐⭐⭐⭐⭐ 原生体验 |
| 性能 | ⭐⭐⭐ 一般 | ⭐⭐⭐⭐⭐ 流畅 |
| 开发成本 | ⭐⭐⭐⭐⭐ 低 | ⭐⭐⭐ 中等 |
| 维护成本 | ⭐⭐⭐⭐⭐ 低 | ⭐⭐⭐ 中等 |

---

## 推荐方案

**建议采用安卓 APP 方案**，理由：

1. **解决打印问题** - 彻底解决美团点餐机打印难题
2. **更好的体验** - 原生应用比浏览器更流畅
3. **离线可用** - 网络不稳定时不影响营业
4. **长期价值** - 为后续功能扩展打下基础

---

## 下一步行动

如果您决定采用此方案，我们可以：

1. **搭建项目框架** - 创建安卓项目基础结构
2. **开发核心功能** - 实现现场点单和打印
3. **集成测试** - 在美团点餐机上测试
4. **部署上线** - 安装到正式环境

需要我开始搭建项目吗？
