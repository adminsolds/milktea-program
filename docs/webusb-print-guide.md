# WebUSB 打印方案使用指南

## 适用场景

适用于**安卓系统**的美团点餐机（如 MT-3Sp），通过 Chrome 浏览器直接控制 USB 打印机。

## 工作原理

```
浏览器(Chrome) 
    ↓ WebUSB API
USB 打印机
    ↓ ESC/POS 指令
打印小票/标签
```

## 系统要求

1. **操作系统**：Android 6.0 或更高版本
2. **浏览器**：Chrome 61 或更高版本
3. **打印机**：支持 ESC/POS 指令的 USB 热敏打印机
4. **USB 权限**：需要用户授权访问 USB 设备

## 使用步骤

### 第一步：连接打印机

1. 将 USB 打印机连接到美团点餐机的 USB 接口
2. 确保打印机已开机

### 第二步：首次使用授权

1. 在 Chrome 浏览器中打开后台现场点单页面
2. 下单时会自动弹出 USB 设备选择对话框
3. 选择您的打印机设备
4. 点击"连接"

**注意**：首次使用时需要授权，之后浏览器会记住该设备。

### 第三步：正常打印

授权完成后，每次下单会自动：
1. 打印小票
2. 打印商品标签

## 支持的打印机

### 已测试的打印机

- 美团 58A 热敏打印机
- 美团 80mm 热敏打印机
- EPSON TM-T88V
- 佳博 GP-58MBIII

### 打印机 VID（Vendor ID）

系统会自动识别以下厂商的打印机：
- 0x0483 - STMicroelectronics
- 0x04b8 - Epson
- 0x067b - Prolific
- 0x0456 - Silicon Labs
- 0x1a86 - QinHeng
- 0x0451 - Texas Instruments

如果您的打印机不在列表中，可以联系我们添加。

## 故障排除

### 问题1：无法弹出设备选择对话框

**症状**：下单后没有弹出 USB 设备选择框

**解决方案**：
1. 检查打印机是否已连接并开机
2. 检查 USB 线是否正常
3. 刷新页面后重试
4. 检查 Chrome 是否有 USB 权限：
   - 打开 `chrome://settings/content/usb`
   - 确保网站有权限访问 USB 设备

### 问题2：选择设备后无法打印

**症状**：选择了打印机但打印失败

**解决方案**：
1. 检查打印机是否支持 ESC/POS 指令
2. 尝试重新连接打印机
3. 检查浏览器控制台错误信息（F12 -> Console）

### 问题3：打印内容乱码

**症状**：打印出来的内容显示乱码

**解决方案**：
1. 打印机可能不支持当前的编码格式
2. 尝试更换打印机驱动
3. 联系打印机厂商确认支持的指令集

### 问题4：浏览器不支持 WebUSB

**症状**：提示"浏览器不支持 WebUSB"

**解决方案**：
1. 确保使用 Chrome 浏览器（版本 61+）
2. 检查 Chrome 是否为最新版本
3. 其他浏览器（如 Edge、Opera）也可能支持

## 安全注意事项

1. **HTTPS 要求**：WebUSB API 需要在 HTTPS 环境下运行（或 localhost）
2. **用户授权**：每次访问新的 USB 设备都需要用户明确授权
3. **权限管理**：用户可以在 Chrome 设置中管理 USB 权限

## 技术细节

### 打印流程

1. **检测支持**：检查浏览器是否支持 WebUSB
2. **请求设备**：弹出设备选择对话框
3. **连接设备**：打开 USB 设备并声明接口
4. **发送指令**：通过 USB 批量传输端点发送 ESC/POS 指令
5. **打印内容**：发送文本和格式化指令
6. **切纸**：发送切纸指令

### ESC/POS 指令

系统使用的 ESC/POS 指令包括：
- `ESC @` - 初始化打印机
- `ESC a n` - 设置对齐方式
- `GS ! n` - 设置字体大小
- `ESC E n` - 设置加粗
- `LF` - 换行
- `GS V m` - 切纸

## 替代方案

如果 WebUSB 无法使用，系统会自动回退到以下方案：

1. **本地打印服务**（Windows 系统）
2. **后端 ESC-POS 打印**（打印机连接服务器）
3. **浏览器打印**（window.print）

## 更新日志

### 2026-02-08
- 实现 WebUSB 打印功能
- 支持 ESC/POS 指令集
- 自动检测设备并回退到备用方案
